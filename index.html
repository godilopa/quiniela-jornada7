<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiniela — Jornada 9</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#f7fafc}
    .card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(10,10,10,0.06);margin-bottom:16px}
    h1{margin-top:0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #e6e6e6;padding:8px;text-align:center}
    select,input{padding:6px;border-radius:6px;border:1px solid #ddd}
    .small{font-size:13px;color:#555'}
    .error{color:#b00020}
    .success{color:green}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0ea5a4;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h1>Quiniela — Jornada 9</h1>

    <label>Tipo de quiniela:
      <select id="tipoQuiniela">
        <!-- Reducción al 13 con columna base-->
        <option value="13_1t_5d">Reducida al 13 — 1 triple y 5 dobles (con columna base)</option>
        <option value="13_0t_7d">Reducida al 13 — 0 triples y 7 dobles (con columna base)</option>

        <!-- Reducción al 12 con columna base-->
        <option value="12_0t_9d">Reducida al 12 — 0 triples y 9 dobles (con columna base)</option>
        <option value="12_0t_10d">Reducida al 12 — 0 triples y 10 dobles (con columna base)</option>
        <option value="12_2t_6d">Reducida al 12 — 2 triples y 6 dobles (con columna base)</option>
        <option value="12_2t_5d">Reducida al 12 — 2 triples y 5 dobles (con columna base)</option>
        <option value="12_5t_2d">Reducida al 12 — 5 triples y 2 dobles (con columna base)</option>
      </select>
    </label>

    <div style="overflow:auto;margin-top:12px">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Partido</th>
            <th>Tipo</th>
            <th>1</th>
            <th>X</th>
            <th>2</th>
            <th>Base</th>
          </tr>
        </thead>
        <tbody id="matchesBody"></tbody>
      </table>
    </div>

<div class="card" style="margin-top:12px">
  <h3>Pleno al 15 — AT.MADRID vs R.MADRID (elige goles para cada equipo)</h3>
  <div style="display:flex;gap:12px;align-items:center">
    <div>
      <div class="small">Local (AT.MADRID)</div>
      <select id="plenoLocal">
        <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="M">M</option>
      </select>
    </div>
    <div>
      <div class="small">Visitante (R.MADRID)</div>
      <select id="plenoVisitante">
        <option value="">--</option>
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="M">M</option>
      </select>
    </div>
  </div>
</div>

<div style="margin-top:12px;display:flex;gap:12px;align-items:center">
  <button id="sendBtn">Enviar a Google Sheets</button>
  <div id="status" class="small"></div>
</div>
</div>

<script>
// === PARTIDOS jornada 9 ===
const matches = [
  {id:1, home:'GETAFE', away:'LEVANTE'},
  {id:2, home:'MALLORCA', away:'ALAVÉS'},
  {id:3, home:'VILLARREAL', away:'ATH.CLUB'},
  {id:4, home:'RAYO', away:'SEVILLA'},
  {id:5, home:'ELCHE', away:'CELTA'},
  {id:6, home:'BETIS', away:'OSASUNA'},
  {id:7, home:'BARCELONA', away:'R.SOCIEDAD'},
  {id:8, home:'VALENCIA', away:'R.OVIEDO'},
  {id:9, home:'EIBAR', away:'DEPORTIVO'},
  {id:10, home:'RACING S.', away:'ANDORRA FC'},
  {id:11, home:'LAS PALMAS', away:'ALMERÍA'},
  {id:12, home:'BURGOS', away:'MÁLAGA'},
  {id:13, home:'CÁDIZ', away:'CEUTA'},
  {id:14, home:'SPORTING', away:'ALBACETE'},
  {id:15, home:'AT.MADRID', away:'R.MADRID'}
];

const matchesBody = document.getElementById('matchesBody');

function buildTable(){
  matchesBody.innerHTML = '';
  // render only 1..14 as filas normales; la 15 queda para Pleno
  matches.slice(0,14).forEach(m => {
    const tr = document.createElement('tr');
    tr.dataset.id = m.id;

    tr.innerHTML = `
      <td>${m.id}</td>
      <td style="text-align:left">${m.home} - ${m.away}</td>
      <td>
        <select class="tipo">
          <option value="S">Simple</option>
          <option value="D">Doble</option>
          <option value="T">Triple</option>
        </select>
      </td>
      <td><input type="checkbox" class="opt" value="1"></td>
      <td><input type="checkbox" class="opt" value="X"></td>
      <td><input type="checkbox" class="opt" value="2"></td>
      <td>
        <select class="base" disabled>
          <option value="">--</option>
        </select>
      </td>
    `;

    matchesBody.appendChild(tr);

    // attach listeners
    const checkboxes = tr.querySelectorAll('input.opt');
    const tipoSel = tr.querySelector('select.tipo');
    const baseSel = tr.querySelector('select.base');

    // when tipo changes, enforce limits
    tipoSel.addEventListener('change', ()=>{
      enforceLimits(tr);
      updateBase(tr);
    });

    // when any checkbox changes
    checkboxes.forEach(cb => cb.addEventListener('change', ()=>{
      // auto-update tipo according to number of checked
      const checkedCount = tr.querySelectorAll('input.opt:checked').length;
      if(checkedCount >= 3) tipoSel.value = 'T';
      else if(checkedCount === 2) tipoSel.value = 'D';
      else if(checkedCount <= 1) tipoSel.value = 'S';

      enforceLimits(tr);
      updateBase(tr);
    }));

  });
}

function enforceLimits(tr){
  const tipo = tr.querySelector('select.tipo').value;
  const boxes = Array.from(tr.querySelectorAll('input.opt'));
  const checked = boxes.filter(b=>b.checked);
  if(tipo === 'S'){
    // keep only the first checked
    if(checked.length > 1){
      let kept = 0;
      boxes.forEach(b=>{ if(b.checked){ if(kept === 0){ kept = 1; } else { b.checked = false; } } });
    }
  } else if(tipo === 'D'){
    if(checked.length > 2){
      let kept = 0;
      boxes.forEach(b=>{ if(b.checked){ if(kept < 2){ kept++; } else { b.checked = false; } } });
    }
  } // T allows all
}

function updateBase(tr){
  const boxes = Array.from(tr.querySelectorAll('input.opt'));
  const checked = boxes.filter(b=>b.checked).map(b=>b.value);
  const baseSel = tr.querySelector('select.base');

  // rebuild options
  baseSel.innerHTML = '';
  if(checked.length === 0){
    baseSel.disabled = true;
    const o = document.createElement('option'); o.value=''; o.textContent='--'; baseSel.appendChild(o);
    return;
  }
  // add options from checked
  const empty = document.createElement('option'); empty.value=''; empty.textContent='--'; baseSel.appendChild(empty);
  checked.forEach(v=>{ const o = document.createElement('option'); o.value = v; o.textContent = v; baseSel.appendChild(o); });
  baseSel.disabled = false;

  // auto-select base when applicable: if only one checked -> pick it
  if(checked.length === 1){ baseSel.value = checked[0]; }
  // if previous value still valid, keep it
  else if(!checked.includes(baseSel.value)) baseSel.value = '';
}

// build UI
buildTable();

// === Envío y validaciones ===
// mapeo de combinaciones soportadas (triples, dobles)
const mapping = {
  // Reducción al 13 (columna base)
  '13_1t_5d': {triples:1, doubles:5},
  '13_0t_7d': {triples:0, doubles:7},

  // Reducción al 12 (columna base) - opciones solicitadas (únicas)
  '12_0t_9d':  {triples:0, doubles:9},
  '12_0t_10d': {triples:0, doubles:10},
  '12_2t_6d':  {triples:2, doubles:6},
  '12_2t_5d':  {triples:2, doubles:5},
  '12_5t_2d':  {triples:5, doubles:2}
};

document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const tipoQuiniela = document.getElementById('tipoQuiniela').value;
  const expected = mapping[tipoQuiniela];
  const rows = Array.from(document.querySelectorAll('#matchesBody tr'));
  let triples = 0, doubles = 0;
  const entries = [];
  const errors = [];

  rows.forEach(tr=>{
    const id = tr.dataset.id;
    const matchText = tr.querySelector('td:nth-child(2)').textContent;
    const tipo = tr.querySelector('select.tipo').value;
    const selections = Array.from(tr.querySelectorAll('input.opt:checked')).map(cb=>cb.value);
    const base = tr.querySelector('select.base').value;

    if(tipo === 'T') triples++;
    if(tipo === 'D') doubles++;

    // checks
    if(selections.length === 0) errors.push(`Partido ${id} (${matchText}): selecciona al menos una opción.`);
    if(tipo === 'S' && selections.length !== 1) errors.push(`Partido ${id}: marcado como SIMPLE pero debe tener 1 selección.`);
    if(tipo === 'D' && selections.length !== 2) errors.push(`Partido ${id}: marcado como DOBLE pero debe tener 2 selecciones.`);
    if(tipo === 'T' && selections.length !== 3) errors.push(`Partido ${id}: marcado como TRIPLE pero debe tener 3 selecciones.`);
    if(!base) errors.push(`Partido ${id}: la columna Base debe estar establecida.`);
    if(base && !selections.includes(base)) errors.push(`Partido ${id}: la Base (${base}) no coincide con las selecciones.`);

    entries.push({id, match: matchText, tipo, selections, base});
  });

  // valida que exista mapping para la opción seleccionada
  if(!expected){
    errors.push('Tipo de quiniela no reconocido o no mapeado. Revisa la selección.');
  } else {
    // validate triples/doubles count
    if(triples !== expected.triples) errors.push(`Se esperaban ${expected.triples} triples pero hay ${triples}.`);
    if(doubles !== expected.doubles) errors.push(`Se esperaban ${expected.doubles} dobles pero hay ${doubles}.`);
  }

  // pleno
  const plenoLocal = document.getElementById('plenoLocal').value;
  const plenoVisitante = document.getElementById('plenoVisitante').value;
  if(!plenoLocal) errors.push('Pleno al 15: elige los goles del equipo local (Elche).');
  if(!plenoVisitante) errors.push('Pleno al 15: elige los goles del equipo visitante (Real Betis).');

  const status = document.getElementById('status');
  if(errors.length){ status.innerHTML = `<span class="error">${errors.join('<br>')}</span>`; return; }

  // payload
  const payload = {
    tipoQuiniela,
    expected,
    summary:{triples,doubles},
    entries,
    pleno15:{ local:plenoLocal, away:plenoVisitante }
  };

  status.textContent = 'Enviando...';

  fetch('https://script.google.com/macros/s/AKfycbzTxXmiAfGi5dEKW4nWjn2ruVkC6ynAm0fI5ovHFXbajXqdtmyXqEkdx8Tb-CQhUJFb/exec', {
    method: 'POST',
    mode: 'cors',
    body: JSON.stringify({ tipoQuiniela, partidos: entries, pleno15: { local: plenoLocal, visitante: plenoVisitante } })
  })
  .then(r => {
    if (!r.ok) throw new Error('Error HTTP: ' + r.status);
    return r.json();
  })
  .then(resp => {
    status.textContent = 'Enviado';
  })
  .catch(err => {
    status.textContent = 'Error: ' + err.message;
  });
});

</script>
</body>
</html>
